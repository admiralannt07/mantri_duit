{% extends 'base.html' %}
{% load humanize %} {% block content %}
<div class="flex flex-col h-[85vh]"> <div class="text-center mb-4">
        <h2 class="text-xl font-bold text-slate-700">Konsultasi Dukun Keuangan ðŸ”®</h2>
        <p class="text-xs text-slate-500">Siap-siap kena mental.</p>
    </div>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 bg-white rounded-xl shadow-inner border border-slate-100 mb-4 space-y-4">
        
        <div class="chat chat-start">
            <div class="chat-image avatar">
                <div class="w-10 rounded-full bg-slate-800 text-white flex items-center justify-center text-lg">ðŸ’¸</div>
            </div>
            <div class="chat-bubble bg-slate-200 text-slate-800">
                Halo bos! Saldo lo tinggal <b>Rp {{ current_balance|intcomma }}</b> nih. <br>
                Mau nanya apa? Jangan minjem duit ya!
            </div>
        </div>

        {% for chat in chats %}
            {% include 'partials/chat_bubble.html' with message=chat.message response=chat.response %}
        {% endfor %}

        <div id="chat-stream"></div>
        
        <div id="loading-chat" class="htmx-indicator chat chat-start">
             <div class="chat-bubble bg-slate-100 text-slate-500 italic">
                <span class="loading loading-dots loading-sm"></span> Mantri lagi mikir...
             </div>
        </div>

    </div>

    <form hx-post="{% url 'chat_api' %}" 
          hx-target="#chat-stream" 
          hx-swap="beforeend" 
          hx-indicator="#loading-chat"
          hx-on::after-request="this.reset()"
          class="flex gap-2">
        
        {% csrf_token %}
        <input type="text" name="message" placeholder="Contoh: Boleh beli iPhone gak?" 
               class="input input-bordered w-full shadow-sm" autocomplete="off" required>
        
        <button type="submit" class="btn btn-primary shadow-sm">
            Kirim ðŸš€
        </button>
    </form>

</div>

<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        const chatContainer = document.getElementById("chat-container");
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
</script>
{% endblock %}